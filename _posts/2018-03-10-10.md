---
layout: post
title: "如何编写一个高滚动性能的组件"
date: 2018-03-10
description: "如何编写一个高滚动性能的组件"
tag: 博客 
---    


### 简介
本篇文章解析了[vue-virtual-collection](https://github.com/starkwang/vue-virtual-collection)组件是如何巧妙运用了“块渲染”的思想去渲染需要的数据。

可以参考下图：  

![](https://pic1.zhimg.com/80/v2-a29ffc281bcb3cd1766dc2d0a3ac643b_hd.jpg)      

该图片完美的解析了“块渲染的思想” , 让我们来分析一下上图。    

为了高效计算视图中显示那些块,我们可以先定义一个 div 为 X * X , 所有与这个div有重叠的Cell(块)都会在这个块记录下来，然后把这个Cell(块)保存到一个Map(相当与一个字典)中,那么当滚动发生时我们就可以从这个Map(相当与一个字典)中找到当前需要渲染出来的块,就不用再去遍历所有的Cell(块)再去进行渲染了。    

试想下比如我们需要在一本字典中找一个我们想要找的单词 , 我们首先想到的是会有两种方法去找。 

1.我们去一页一页的去翻去查找。   
2.我们通过字典的索引去查找。   

上面两种方法我会毫不犹豫的选第二种,而"把这个Cell(块)保存到一个Map中再去查找"道理是一样的。

此时，Map中记录的应该是：    
```html
{
  "0.0": [1, 2, 3, 5], // 0.0块与1,2,3,5号Cell有重叠，下同
  "0.1": [5, 3, 6, 7],
  "0.2": [7, 6, 8, 9],
  "1.0": [2, 3, 4],
  "1.1": [3, 4, 6],
  "1.2": [6, 9]
}
```    

当我们滚动了页面，根据滚动的距离、viewPort 的宽高，可以很容易计算出当前需要渲染哪些块。

  
### 源码解析

**第一步我们先去创建一个div为包裹层**   

```html
<template>
  <div class="vue-wrapper" :style="wrapperStyle">

  </div>
</template>

<script>
  export default {
    data () {
      return {
        height: 500,
        width: 500
      }
    },
    computed: {
      wrapperStyle () {
        return {
          height: `${this.height}px`,
          width: `${this.height}px`
        }
      }
    }
  }
</script>
<style>
  .vue-wrapper {
    overflow: scroll;
    -webkit-overflow-scrolling: touch;
  }
</style>
```

**因为要设置我们需要显示那些数据，所以我们需要为每一个块都设置一个信息,表示当前块包含哪些或者说与哪些块是重叠在一起的**   
```html
Section.js
/**
   *窗口的显示部分 -> 当前viewPort显示的部分。
   *把cell(块)组合起来显示在当前的窗口。
   *这使我们能够更快地确定在窗口的给定区域显示哪些单元格。
   *显示具有固定的大小，并包含0到多个块（由其索引跟踪）。
 */

export default class Section {
  constructor ({width, height, x, y}) {
    this.width = width;
    this.height = height;
    this.x = x;
    this.y = y;

    // 收集当前应该显示那些块
    this._indexMap = {};

    // 收集当前需要显示块的索引
    this._indices = [];
  }

  // 有添加就有获取

  // 添加块的索引
  addCellIndex ({index}) {
    if (!this._indexMap[index]) {
      // 收集当前应该显示那些块
      this._indexMap[index] = true;
      // 收集当前需要显示块的索引并保持它们
      this._indices.push(index);
    }
  }

  // 获取块的
  getCellIndex () {
    this._indices;
  }
}

```  

**再接下来就是创建一个类(class用于管理设置我们需要显示那些块到当前的视图中**

```html

```












